<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Metro Train Station Entries · FY24-25 vs FY23-24</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      color-scheme: light;
      --surface: #ffffff;
      --surface-soft: #f5f6fb;
      --border: #d6dbe2;
      --text: #1f2430;
      --text-muted: #4c566d;
      --accent: #3f53d9;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      background: var(--surface-soft);
      color: var(--text);
    }

    main {
      max-width: 1280px;
      margin: 0 auto;
      padding: 32px 24px 48px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    header h1 {
      margin: 0;
      font-size: clamp(1.9rem, 2.2vw, 2.6rem);
    }

    header p {
      margin: 8px 0 0;
      max-width: 780px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    #status-message {
      margin: 12px 0 4px;
      font-style: italic;
      color: var(--accent);
    }

    #viz-panels {
      display: grid;
      gap: 24px;
      grid-template-columns: minmax(0, 1.55fr) minmax(0, 1fr);
      align-items: start;
    }

    figure {
      margin: 0;
      background: var(--surface);
      border-radius: 18px;
      border: 1px solid var(--border);
      padding: 22px 22px 28px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      box-shadow: 0 12px 32px rgba(31, 41, 61, 0.08);
    }

    figure h2 {
      margin: 0;
      font-size: 1.25rem;
    }

    figure p.lead {
      margin: 0;
      color: var(--text-muted);
      font-size: 0.95rem;
      line-height: 1.45;
    }

    #map,
    #bar-chart {
      width: 100%;
      height: auto;
    }

    .map-base .base-stop {
      fill: #d4d9e0;
      opacity: 0.55;
    }

    .station-marker {
      cursor: pointer;
      fill-opacity: 0.88;
      transition: r 0.18s ease, fill-opacity 0.18s ease, stroke-width 0.18s ease;
    }

    .station-marker.highlighted {
      stroke-width: 1.8;
      fill-opacity: 1;
    }

    .legend-container {
      display: flex;
      flex-wrap: wrap;
      gap: 18px;
    }

    .legend-box {
      background: #f4f7ff;
      border: 1px solid #d9e1ff;
      border-radius: 12px;
      padding: 12px 14px;
    }

    .legend-title {
      font-size: 0.83rem;
      font-weight: 600;
      fill: var(--text-muted);
    }

    #bar-panel .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    #bar-panel .button-group {
      display: inline-flex;
      gap: 8px;
    }

    #bar-panel button {
      appearance: none;
      border-radius: 999px;
      border: 1px solid #c8cee4;
      background: #eff2ff;
      color: #314174;
      padding: 6px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.18s ease, color 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease;
    }

    #bar-panel button:hover {
      border-color: #adb7dc;
      background: #e4e9ff;
    }

    #bar-panel button[aria-pressed="true"] {
      background: var(--accent);
      border-color: var(--accent);
      color: #ffffff;
      box-shadow: 0 0 0 3px rgba(63, 83, 217, 0.18);
    }

    .axis path,
    .axis line {
      stroke: #b6bed5;
    }

    .axis text {
      fill: #46506a;
      font-size: 0.82rem;
    }

    .zero-line {
      stroke: #9da8c7;
      stroke-dasharray: 3 4;
    }

    rect.bar {
      opacity: 0.92;
    }

    text.bar-value {
      fill: #1f2a44;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .tooltip {
      position: fixed;
      pointer-events: none;
      background: rgba(24, 30, 44, 0.92);
      color: #ffffff;
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 0.85rem;
      line-height: 1.4;
      opacity: 0;
      transform: translate3d(0, 0, 0);
      transition: opacity 0.18s ease;
      z-index: 10;
      max-width: 260px;
      box-shadow: 0 10px 24px rgba(8, 13, 29, 0.32);
    }

    footer {
      font-size: 0.8rem;
      color: var(--text-muted);
      line-height: 1.4;
      margin-top: 12px;
    }

    @media (max-width: 1080px) {
      #viz-panels {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 640px) {
      main {
        padding: 24px 16px 40px;
      }

      figure {
        padding: 18px 16px 24px;
      }

      #bar-panel .panel-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Metro Train Station Entries · FY24-25 vs FY23-24</h1>
      <p>
        Explore how annual patronage shifted across Melbourne&rsquo;s metropolitan train stations.
        Symbol size reflects total entries in the latest available year, while colour encodes the
        change compared with FY23-24. Hover the map or the leaderboard to inspect individual stops.
      </p>
    </header>

    <p id="status-message">Loading data…</p>

    <section id="viz-panels">
      <figure id="map-panel">
        <div>
          <h2>Network map</h2>
          <p class="lead">
            Larger, greener circles indicate stations that grew substantially in FY24-25.
            Grey points mark the broader metro stop network for context.
          </p>
        </div>
        <svg id="map" role="img" aria-label="Metro train station map with ridership changes"></svg>
        <div class="legend-container">
          <div id="size-legend" class="legend-box"></div>
          <div id="color-legend" class="legend-box"></div>
        </div>
      </figure>

      <figure id="bar-panel">
        <div class="panel-header">
          <div>
            <h2>Biggest changes in patronage</h2>
            <p class="lead">Toggle between growth leaders and the sharpest drops across the network.</p>
          </div>
          <div class="button-group">
            <button type="button" data-mode="increase" aria-pressed="true">Top increases</button>
            <button type="button" data-mode="decrease" aria-pressed="false">Top decreases</button>
          </div>
        </div>
        <svg id="bar-chart" role="img" aria-label="Bar chart of metro stations with largest patronage changes"></svg>
      </figure>
    </section>

    <footer>
      Data sources: annual metropolitan train station entries (FY23-24, FY24-25) and Public Transport Victoria stop locations.
    </footer>
  </main>

  <div id="tooltip" class="tooltip"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const numericColumns = [
        "Pax_annual",
        "Pax_weekday",
        "Pax_norm_weekday",
        "Pax_sch_hol_weekday",
        "Pax_Saturday",
        "Pax_Sunday",
        "Pax_pre_AM_peak",
        "Pax_AM_peak",
        "Pax_interpeak",
        "Pax_PM_peak",
        "Pax_PM_late"
      ];

      const formatComma = d3.format(",");
      const formatDelta = d3.format("+,.0f");
      const formatPct = d3.format("+.1f");
      const formatAxis = d3.format("~s");

      const mapWidth = 720;
      const mapHeight = 640;
      const barMargin = { top: 28, right: 20, bottom: 44, left: 190 };
      const barWidth = 560;
      const barHeight = 640;
      const innerBarWidth = barWidth - barMargin.left - barMargin.right;
      const innerBarHeight = barHeight - barMargin.top - barMargin.bottom;

      const statusEl = d3.select("#status-message");
      const tooltip = d3.select("#tooltip");

      const mapSvg = d3
        .select("#map")
        .attr("viewBox", `0 0 ${mapWidth} ${mapHeight}`);

      const mapBase = mapSvg.append("g").attr("class", "map-base");
      const mapMarkersLayer = mapSvg.append("g").attr("class", "map-markers");

      const barSvg = d3
        .select("#bar-chart")
        .attr("viewBox", `0 0 ${barWidth} ${barHeight}`);

      const barG = barSvg
        .append("g")
        .attr("transform", `translate(${barMargin.left},${barMargin.top})`);

      const xScale = d3.scaleLinear().range([0, innerBarWidth]);
      const yScale = d3.scaleBand().range([0, innerBarHeight]).padding(0.18);

      const xAxisGroup = barG
        .append("g")
        .attr("class", "axis axis-x")
        .attr("transform", `translate(0,${innerBarHeight})`);

      const yAxisGroup = barG.append("g").attr("class", "axis axis-y");

      barG
        .append("line")
        .attr("class", "zero-line")
        .attr("x1", 0)
        .attr("x2", 0)
        .attr("y1", 0)
        .attr("y2", innerBarHeight);

      function parseRow(d) {
        const row = {
          id: (d.Stop_ID ?? d.stop_id ?? d.STOP_ID ?? "").toString().trim(),
          name: (d.Stop_name ?? d.stop_name ?? d.STOP_NAME ?? "").trim(),
          lat: parseFloat(d.Stop_lat ?? d.stop_lat ?? d.Stop_Lat ?? ""),
          lon: parseFloat(d.Stop_long ?? d.stop_long ?? d.Stop_Long ?? ""),
          finYear: (d.Fin_year ?? d["﻿Fin_year"] ?? d.fin_year ?? d.FIN_YEAR ?? "")
            .toString()
            .trim()
        };

        if (!Number.isFinite(row.lat)) row.lat = null;
        if (!Number.isFinite(row.lon)) row.lon = null;

        numericColumns.forEach(col => {
          const raw = d[col];
          if (raw === undefined || raw === null || String(raw).trim() === "") {
            row[col] = null;
          } else {
            row[col] = +raw;
          }
        });

        return row;
      }

      Promise.all([
        d3.json("public_transport_stops.geojson"),
        d3.csv("annual_metropolitan_train_station_entries_fy_2023_2024.csv", parseRow),
        d3.csv("annual_metropolitan_train_station_entries_fy_2024_2025.csv", parseRow)
      ])
        .then(([stopsGeo, fy2324, fy2425]) => {
          statusEl.text("Loaded metro train stops and annual entry counts.");

          const metroTrainFeatures = (stopsGeo?.features ?? [])
            .filter(f => f.properties && f.properties.MODE === "METRO TRAIN")
            .map(f => ({
              coordinates: Array.isArray(f.geometry?.coordinates)
                ? f.geometry.coordinates
                : null,
              name: f.properties?.STOP_NAME ?? ""
            }))
            .filter(
              f =>
                Array.isArray(f.coordinates) &&
                Number.isFinite(f.coordinates[0]) &&
                Number.isFinite(f.coordinates[1])
            );

          const stationById = new Map();

          function ingest(row) {
            if (!row || !row.id) return;
            const record =
              stationById.get(row.id) ?? {
                id: row.id,
                name: "",
                lat: null,
                lon: null,
                years: {}
              };

            if (row.name && row.name.length > record.name.length) {
              record.name = row.name;
            }
            if (Number.isFinite(row.lat)) record.lat = row.lat;
            if (Number.isFinite(row.lon)) record.lon = row.lon;
            if (row.finYear) {
              record.years[row.finYear] = { ...row };
            }

            stationById.set(row.id, record);
          }

          fy2324.forEach(ingest);
          fy2425.forEach(ingest);

          const stations = Array.from(stationById.values())
            .map(record => {
              const entry23 = record.years["FY23-24"] ?? null;
              const entry24 = record.years["FY24-25"] ?? null;
              const fallback = entry24 ?? entry23;

              const lat = Number.isFinite(record.lat)
                ? record.lat
                : fallback?.lat ?? null;
              const lon = Number.isFinite(record.lon)
                ? record.lon
                : fallback?.lon ?? null;

              const pax23 =
                entry23 && entry23.Pax_annual != null ? entry23.Pax_annual : null;
              const pax24 =
                entry24 && entry24.Pax_annual != null ? entry24.Pax_annual : null;
              const delta =
                pax23 != null && pax24 != null ? pax24 - pax23 : null;
              const changePct =
                pax23 != null && pax24 != null && pax23 !== 0
                  ? (delta / pax23) * 100
                  : null;

              return {
                id: record.id,
                name: record.name || fallback?.name || "Unknown station",
                lat,
                lon,
                entry23,
                entry24,
                pax23,
                pax24,
                delta,
                changePct,
                currentYear: entry24 ? "FY24-25" : entry23 ? "FY23-24" : null,
                currentPax: entry24 ? pax24 : pax23
              };
            })
            .filter(
              d =>
                Number.isFinite(d.lat) && Number.isFinite(d.lon) && d.currentPax != null
            );

          stations.sort((a, b) => d3.descending(a.currentPax, b.currentPax));

          const maxPax = d3.max(stations, d => d.currentPax) || 1;
          const maxAbsDelta =
            d3.max(stations, d => Math.abs(d.delta ?? 0)) || 1;

          const sizeScale = d3
            .scaleSqrt()
            .domain([0, maxPax])
            .range([3, 18])
            .nice();

          const colorScale = d3
            .scaleDiverging()
            .domain([-maxAbsDelta, 0, maxAbsDelta])
            .interpolator(d3.interpolateRdYlGn)
            .clamp(true);

          const projection = d3.geoMercator();

          if (metroTrainFeatures.length) {
            const featureCollection = {
              type: "FeatureCollection",
              features: metroTrainFeatures.map(f => ({
                type: "Feature",
                geometry: { type: "Point", coordinates: f.coordinates }
              }))
            };
            projection.fitSize([mapWidth, mapHeight], featureCollection);
          } else {
            const featureCollection = {
              type: "FeatureCollection",
              features: stations.map(d => ({
                type: "Feature",
                geometry: { type: "Point", coordinates: [d.lon, d.lat] }
              }))
            };
            projection.fitSize([mapWidth, mapHeight], featureCollection);
          }

          if (metroTrainFeatures.length) {
            mapBase
              .selectAll("circle")
              .data(metroTrainFeatures)
              .join("circle")
              .attr("class", "base-stop")
              .attr("cx", d => projection(d.coordinates)[0])
              .attr("cy", d => projection(d.coordinates)[1])
              .attr("r", 2.2);
          }

          const markers = mapMarkersLayer
            .selectAll("circle")
            .data(stations, d => d.id)
            .join("circle")
            .attr("class", "station-marker")
            .attr("tabindex", 0)
            .attr("cx", d => projection([d.lon, d.lat])[0])
            .attr("cy", d => projection([d.lon, d.lat])[1])
            .attr("r", d => sizeScale(d.currentPax))
            .attr("fill", d => (d.delta == null ? "#8a8f9f" : colorScale(d.delta)))
            .attr("stroke", "#181f30")
            .attr("stroke-width", 0.6)
            .attr("data-station-id", d => d.id);

          const focusMarker = id => {
            markers.classed("highlighted", d => d.id === id);
          };

          const clearMarkerFocus = () => {
            markers.classed("highlighted", false);
          };

          function changePctText(value) {
            if (value == null) return "n/a";
            return `${formatPct(value)}%`;
          }

          function showTooltip(event, d) {
            const lines = [
              `<strong>${d.name}</strong>`,
              d.currentYear
                ? `${d.currentYear} entries: ${formatComma(d.currentPax)}`
                : `Entries: ${formatComma(d.currentPax)}`,
              d.entry23 && d.entry24
                ? `FY23-24: ${formatComma(d.pax23)} · FY24-25: ${formatComma(d.pax24)}`
                : "",
              d.delta != null
                ? `Change: ${formatDelta(d.delta)} (${changePctText(d.changePct)})`
                : "Change: not available"
            ].filter(Boolean);

            tooltip
              .html(lines.join("<br>"))
              .style("opacity", 1)
              .style("left", `${event.clientX + 18}px`)
              .style("top", `${event.clientY + 18}px`);
          }

          function hideTooltip() {
            tooltip.style("opacity", 0);
          }

          markers
            .on("pointerenter focus", (event, d) => {
              focusMarker(d.id);
              showTooltip(event, d);
            })
            .on("pointermove", showTooltip)
            .on("pointerleave blur", () => {
              clearMarkerFocus();
              hideTooltip();
            });

          const deltaExtent = d3.extent(
            stations.filter(d => d.delta != null),
            d => d.delta
          );

          xScale
            .domain([
              Math.min(0, deltaExtent[0] ?? 0),
              Math.max(0, deltaExtent[1] ?? 0)
            ])
            .nice();

          const zeroX = xScale(0);
          barG
            .select(".zero-line")
            .attr("x1", zeroX)
            .attr("x2", zeroX);

          function renderBars(mode) {
            const dataset = stations
              .filter(d => d.delta != null)
              .sort((a, b) =>
                mode === "decrease"
                  ? d3.ascending(a.delta, b.delta)
                  : d3.descending(a.delta, b.delta)
              )
              .slice(0, 12);

            yScale.domain(dataset.map(d => d.name));

            const bars = barG.selectAll("rect.bar").data(dataset, d => d.id);

            bars
              .exit()
              .transition()
              .duration(200)
              .attr("width", 0)
              .remove();

            const barsEnter = bars
              .enter()
              .append("rect")
              .attr("class", "bar")
              .attr("tabindex", 0)
              .attr("x", zeroX)
              .attr("y", d => yScale(d.name))
              .attr("width", 0)
              .attr("height", yScale.bandwidth())
              .attr("fill", d => colorScale(d.delta))
              .on("pointerenter focus", (event, d) => {
                focusMarker(d.id);
                showTooltip(event, d);
              })
              .on("pointermove", showTooltip)
              .on("pointerleave blur", () => {
                clearMarkerFocus();
                hideTooltip();
              });

            barsEnter
              .merge(bars)
              .transition()
              .duration(500)
              .attr("y", d => yScale(d.name))
              .attr("height", yScale.bandwidth())
              .attr("x", d => Math.min(xScale(d.delta), zeroX))
              .attr("width", d => Math.abs(xScale(d.delta) - zeroX))
              .attr("fill", d => colorScale(d.delta));

            const labels = barG
              .selectAll("text.bar-value")
              .data(dataset, d => d.id);

            labels
              .exit()
              .transition()
              .duration(200)
              .style("opacity", 0)
              .remove();

            const labelsEnter = labels
              .enter()
              .append("text")
              .attr("class", "bar-value")
              .attr("y", d => yScale(d.name) + yScale.bandwidth() / 2)
              .attr("x", zeroX + 6)
              .attr("dy", "0.35em")
              .attr("text-anchor", d => (d.delta >= 0 ? "start" : "end"))
              .style("opacity", 0)
              .on("pointerenter focus", (event, d) => {
                focusMarker(d.id);
                showTooltip(event, d);
              })
              .on("pointermove", showTooltip)
              .on("pointerleave blur", () => {
                clearMarkerFocus();
                hideTooltip();
              });

            labelsEnter
              .merge(labels)
              .transition()
              .duration(500)
              .attr("y", d => yScale(d.name) + yScale.bandwidth() / 2)
              .attr("x", d =>
                d.delta >= 0 ? xScale(d.delta) + 6 : xScale(d.delta) - 6
              )
              .attr("text-anchor", d => (d.delta >= 0 ? "start" : "end"))
              .text(d => `${formatDelta(d.delta)} (${changePctText(d.changePct)})`)
              .style("opacity", 1);

            xAxisGroup
              .transition()
              .duration(500)
              .call(
                d3
                  .axisBottom(xScale)
                  .ticks(5)
                  .tickFormat(formatAxis)
              )
              .call(g => g.selectAll("text").attr("dy", "1.5em"));

            yAxisGroup
              .transition()
              .duration(500)
              .call(d3.axisLeft(yScale).tickSizeOuter(0));

            d3.selectAll('#bar-panel button[data-mode]').attr("aria-pressed", null);
            d3.select(`#bar-panel button[data-mode="${mode}"]`).attr(
              "aria-pressed",
              "true"
            );
          }

          renderBars("increase");

          d3.select('#bar-panel button[data-mode="increase"]').on("click", () =>
            renderBars("increase")
          );
          d3.select('#bar-panel button[data-mode="decrease"]').on("click", () =>
            renderBars("decrease")
          );

          buildLegends(sizeScale, maxPax, colorScale, maxAbsDelta);

          statusEl.text(
            `Showing ${stations.length} metro stations. Hover the map or leaderboard to explore changes between FY23-24 and FY24-25.`
          );
        })
        .catch(error => {
          console.error(error);
          statusEl.text(
            "Could not load one or more data files. Check the developer console for details."
          );
        });

      function buildLegends(sizeScale, maxPax, colorScale, maxAbsDelta) {
        const sizeLegend = d3
          .select("#size-legend")
          .append("svg")
          .attr("width", 200)
          .attr("height", 74);

        sizeLegend
          .append("text")
          .attr("class", "legend-title")
          .attr("x", 0)
          .attr("y", 14)
          .text("Circle size · entries (latest year)");

        const legendGroup = sizeLegend
          .append("g")
          .attr("transform", "translate(12,56)");

        const samples = [0.25, 0.55, 1].map(t => t * maxPax);
        const radii = samples.map(sizeScale);
        const baseline = 38;

        legendGroup
          .selectAll("circle")
          .data(radii)
          .join("circle")
          .attr("cx", (d, i) => i * 62)
          .attr("cy", d => baseline - d)
          .attr("r", d => d)
          .attr("fill", "#c8d9ff")
          .attr("stroke", "#475f9c");

        legendGroup
          .selectAll("line")
          .data(radii)
          .join("line")
          .attr("x1", (d, i) => i * 62)
          .attr("x2", (d, i) => i * 62)
          .attr("y1", baseline)
          .attr("y2", baseline + 6)
          .attr("stroke", "#475f9c")
          .attr("stroke-width", 1);

        legendGroup
          .selectAll("text")
          .data(samples)
          .join("text")
          .attr("x", (d, i) => i * 62)
          .attr("y", baseline + 20)
          .attr("text-anchor", "middle")
          .text(d3.format(".2s"));

        const colorLegendWidth = 240;
        const colorLegendHeight = 54;
        const colorLegend = d3
          .select("#color-legend")
          .append("svg")
          .attr("width", colorLegendWidth)
          .attr("height", colorLegendHeight);

        colorLegend
          .append("text")
          .attr("class", "legend-title")
          .attr("x", 0)
          .attr("y", 14)
          .text("Colour · change in entries (FY24-25 vs FY23-24)");

        const defs = colorLegend.append("defs");
        const gradient = defs
          .append("linearGradient")
          .attr("id", "delta-gradient");

        const steps = 40;
        for (let i = 0; i <= steps; i += 1) {
          const t = i / steps;
          const value = -maxAbsDelta + 2 * maxAbsDelta * t;
          gradient
            .append("stop")
            .attr("offset", `${(t * 100).toFixed(1)}%`)
            .attr("stop-color", colorScale(value));
        }

        colorLegend
          .append("rect")
          .attr("x", 0)
          .attr("y", 22)
          .attr("width", colorLegendWidth)
          .attr("height", 14)
          .attr("fill", "url(#delta-gradient)");

        const legendScale = d3
          .scaleLinear()
          .domain([-maxAbsDelta, maxAbsDelta])
          .range([0, colorLegendWidth]);

        const legendAxis = d3
          .axisBottom(legendScale)
          .ticks(4)
          .tickFormat(d3.format("~s"));

        colorLegend
          .append("g")
          .attr("class", "axis legend-axis")
          .attr("transform", `translate(0, ${22 + 14})`)
          .call(legendAxis);
      }
    });
  </script>
</body>
</html>
