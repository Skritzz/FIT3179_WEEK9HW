{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Proportional symbol map of Melbourne METRO TRAIN station patronage.",
  "config": {"view": {"stroke": null}},
  "width": "container",
  "height": 620,
  "projection": {"type": "mercator"},
  "layer": [
    {
      "name": "stations",
      "data": {
        "url": "data/public_transport_stops.geojson"
      },
      "transform": [
        { "calculate": "datum.geometry && datum.geometry.coordinates ? datum.geometry.coordinates[0] : null", "as": "lon" },
        { "calculate": "datum.geometry && datum.geometry.coordinates ? datum.geometry.coordinates[1] : null", "as": "lat" },
        { "filter": "datum.properties && datum.properties.MODE == 'METRO TRAIN'" },

        {
          "lookup": "properties.STOP_ID",
          "from": {
            "data": { "url": "data/station_patronage_2023_2024.csv" },
            "key": "Stop_ID",
            "fields": ["Fin_year","Stop_name","Pax_annual","Pax_weekday","Pax_Saturday","Pax_Sunday","Pax_AM_peak","Pax_PM_peak"]
          },
          "as": ["Fin_year","Stop_name_csv","Pax_annual","Pax_weekday","Pax_Saturday","Pax_Sunday","Pax_AM_peak","Pax_PM_peak"]
        },

        { "filter": "isValid(datum.lon) && isValid(datum.lat) && isFinite(datum.Pax_annual)" }
      ],
      "mark": { "type": "circle", "opacity": 0.9, "stroke": "#333", "strokeWidth": 0.4 },
      "encoding": {
        "longitude": { "field": "lon", "type": "quantitative" },
        "latitude":  { "field": "lat", "type": "quantitative" },
        "size": {
          "field": "Pax_annual",
          "type": "quantitative",
          "title": "Annual entries",
          "scale": { "type": "sqrt", "range": [12, 1600] },
          "legend": { "orient": "right" }
        },
        "color": {
          "field": "Pax_annual",
          "type": "quantitative",
          "title": "Annual entries"
        },
        "tooltip": [
          { "field": "properties.STOP_NAME", "type": "nominal", "title": "Station (PTV)" },
          { "field": "Stop_name_csv", "type": "nominal", "title": "Station (CSV)" },
          { "field": "Pax_annual", "type": "quantitative", "title": "Annual entries", "format": "," },
          { "field": "Pax_AM_peak", "type": "quantitative", "title": "AM peak avg", "format": "," },
          { "field": "Pax_PM_peak", "type": "quantitative", "title": "PM peak avg", "format": "," },
          { "field": "Fin_year", "type": "nominal", "title": "Fin. year" },
          { "field": "properties.STOP_ID", "type": "nominal", "title": "STOP_ID" }
        ]
      }
    }
  ],
  "title": {
    "text": "Melbourne METRO TRAIN Station Patronage (Annual Entries)",
    "anchor": "start",
    "subtitle": "Circles sized by Pax_annual; data joined via STOP_ID"
  }
}
